# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

commands:
  dockerhub_login:
    description: "Logs into Dockerhub"
    parameters:
      username:
        type: string
      token:
        type: string
    steps:
      - run: echo << parameters.token >> | docker login -u << parameters.username >> --password-stdin

executors:
  builder:
    docker:
      - image: kyrielight/takibi:latest # Custom image specifically for building Java projects using Bazel
    resource_class: medium
    working_directory: /tmp/athenaeum

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build_binary:
    executor: builder
    steps:
      - checkout
      - run: |
          bazel build //:jusagi_deploy.jar
      - persist_to_workspace:
          root: bazel-bin
          paths:
            - jusagi_deploy.jar
  downstream:
    executor: builder
    steps:
      - attach_workspace:
          at: /tmp/athenaeum/bazel-bin
      
      - run: |
          if [ -f /tmp/athenaeum/bazel-bin/ ]; then
            echo "Deploy jar exists";
          else
            echo "Deploy jar not found";
          fi

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_test:
    jobs:
      - build_binary
      - downstream:
          requires:
            - build_binary
